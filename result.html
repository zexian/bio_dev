<!DOCTYPE html>

<html>
    <head>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
        <script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/parse/1.2.9/parse.min.js"></script>
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/css/ratchet-theme-ios.css">
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/css/ratchet-theme-ios.min.css">
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/css/ratchet.css">
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/css/ratchet.min.css">
        <script src="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/js/ratchet.js"></script>
        <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/js/ratchet.min.js"></script>
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">



        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <title>Buoy</title>
    </head>
    <body> 
        <div class="segmented-control">
          <a href="#buoy_result" id="fb_sc" class="control-item active">Buoy Result</a>

        </div>

        <span id="buoy_result" class="control-content active">
        <ul class="table-view">
        </ul>
        </span>

        

       

      <script>
      $("#fb_sc").on('click', function(){
        $("#fb_sc").addClass('active');
        $("#buoy_result").addClass('active');
        $("#linkedin_result").removeClass('active');
        $("#lk_sc").removeClass('active');
        $("#nearby_result").removeClass('active');
        $("#n_sc").removeClass('active');

        $("#buoy_result").show()
        $("#nearby_result").hide()
        $("#linkedin_result").hide()
      });
      

      

      </script>
      


      </div>
        <script type="text/javascript">
          //function for loading all rows under Buoy tab
          function loadBuoyData() {
            Parse.User.current().fetch({
              success:function(myobj){
                //Parse.User.current() = myobj;
              },
              error:function(error){
                alert(error);
              }
            });
            
            var currentUser = Parse.User.current(); 
            var friends_list = currentUser.get('friends');  
            var friend_obj = JSON.parse(friends_list);
            
            var ids = [];
            for (var i = 0; i < friend_obj.length; i++){
              ids.push(friend_obj[i].id);
            }
            var friend_names = [];
            var friend_numbers = [];
            var friend_starttime = [];
            var friend_distance = [];
            var friend_pictures = [];
            var query = new Parse.Query("User");
            query.containedIn('fb_id', ids);
            query.find({
              success: function(results){
                for (var k = 0; k < results.length; k++)
                {
                  var currFriend = results[k];
                  friend_names.push(currFriend.get('name'));
                  friend_numbers.push(currFriend.get('phone_number'));
                  friend_starttime.push(currFriend.get('start_time'));
                  friend_distance.push(currFriend.get('distance'));
                  friend_pictures.push(currFriend.get('profile_picture'));

                }
                buildBuoyRows(friend_names, friend_numbers, friend_starttime, friend_distance, friend_pictures);
              },
              error: function(error){
                alert(JSON.stringify(error));
              }
            });
          }
          function buildBuoyRows(names, numbers, start, distance, pictures) {
            for(var i = 0; i < names.length; i++)
            {
              var hour = start[i].getHours();
              var minute = start[i].getMinutes();
              var AMPM = "AM";
              if(hour >= 12)
              {
                AMPM = "PM";
                hour = hour -12; 
              }
              //append all the users here
              $('#buoy_result').append("<ul class='table-view-cell' id = 'fbCell1'><img src='" + pictures[i] + "'>" + 
            "<div class='person-name'>" + names[i] + "</div>" +
            "<div class='availability'>Available: " + hour + ":" + minute + AMPM + "</div>" + 
            "<div class='distance'>" + distance[i] +" miles </div>" + 
            "<button class='smsbutton btn btn-primary'>Say Hi!" + 
            "</button></ul>")
            }
          }
    


          loadBuoyData();



        </script>


        <script>


          //get the selected user and fields
          var selected_name;
          var selected_number;


          var query = new Parse.Query("User");
          query.equalTo('name', selected_name);
          query.first({
            success: function(object){
              selected_name = object.get('name');
              selected_number = object.get('phone_number');
            },
            error: function(error){
              alert(JSON.stringify(error));
            }
          });

          $( document ).on( "click", ".smsbutton", function() {
            id = $(this).attr('id');
            arr = id.split("-");
            selected_name = arr[0];
            selected_number = arr[1];
            console.log("button works");

            var currentUser = Parse.User.current();
            var user_time = currentUser.get('start_time');
            var user_hour = user_time.getHours();
            var user_minute = user_time.getMinutes();
            var user_number = currentUser.get('phone_number');

            var msg = "Hi " + selected_name + "! I'm available at " + user_hour + ":" + user_minute + ". Message me back at " + user_number + "!" 
            var sendtonumber = "shikhar@u.northwestern.edu";
            Parse.Cloud.run('sendSMS', { smsmessage: msg, number: sendtonumber}, {
              success: function(result) {
                // result is 'Hello world!'
                console.log("" + JSON.stringify(result));
              },
              error: function(error) {
                console.log("" + JSON.stringify(error));
              }
            });

          })


        </script>
       
      </body>
</html>
